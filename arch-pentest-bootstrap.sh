#!/usr/bin/env bash
set -euo pipefail

### ----------- Pre-checks -----------

if [[ $EUID -eq 0 ]]; then
  echo "❌ No ejecutes este script como root. Usa un usuario con sudo."
  exit 1
fi

if ! command -v sudo &>/dev/null; then
  echo "❌ sudo no está instalado."
  exit 1
fi

if ! command -v pacman &>/dev/null; then
  echo "❌ Este script es solo para Arch Linux."
  exit 1
fi

echo "✔️ Pre-checks OK"

### ----------- [1/7] Sistema -----------

echo "[1/7] Actualizando sistema..."
sudo pacman -Syu --noconfirm

### ----------- [2/7] base-devel -----------

echo "[2/7] Instalando base-devel..."
sudo pacman -S --needed --noconfirm base-devel

### ----------- [3/7] Herramientas -----------

echo "[3/7] Instalando herramientas básicas..."
sudo pacman -S --needed --noconfirm \
  net-tools \
  vim nano \
  git curl wget \
  htop \
  man-db man-pages \
  bash-completion \
  which tree \
  unzip zip p7zip \
  lsof strace

### ----------- [4/7] Fuentes -----------

echo "[4/7] Instalando fuentes..."
sudo pacman -S --needed --noconfirm \
  ttf-dejavu \
  ttf-liberation \
  noto-fonts \
  noto-fonts-emoji \
  ttf-jetbrains-mono

### ----------- [5/7] VirtualBox -----------

echo "[5/7] Instalando VirtualBox Guest Utils..."

kernel_pkg="$(pacman -Qq linux 2>/dev/null || true)"

if [[ -n "$kernel_pkg" ]]; then
  sudo pacman -S --needed --noconfirm \
    virtualbox-guest-utils \
    virtualbox-guest-modules-arch
else
  sudo pacman -S --needed --noconfirm \
    virtualbox-guest-utils \
    virtualbox-guest-dkms \
    linux-headers
fi

if systemctl is-system-running &>/dev/null; then
  sudo systemctl enable vboxservice --now
else
  echo "⚠️ systemd no activo, vboxservice no habilitado."
fi

### ----------- [6/7] paru -----------

echo "[6/7] Instalando paru..."

if command -v paru &>/dev/null; then
  echo "✔️ paru ya está instalado"
else
  cd /tmp
  rm -rf paru
  git clone https://aur.archlinux.org/paru.git
  cd paru
  makepkg -si --noconfirm --needed
fi

### ----------- [7/7] Red + Audio -----------

echo "[7/7] Configurando red, Bluetooth y audio..."

sudo pacman -S --needed --noconfirm \
  networkmanager \
  network-manager-applet \
  wpa_supplicant \
  bluez \
  bluez-utils \
  blueman \
  pipewire \
  pipewire-pulse \
  pipewire-alsa \
  wireplumber \
  pavucontrol

if systemctl is-system-running &>/dev/null; then
  sudo systemctl enable NetworkManager --now
  sudo systemctl enable bluetooth --now
else
  echo "⚠️ systemd no activo, servicios no habilitados."
fi

echo "✅ Listo. Sistema base configurado."
