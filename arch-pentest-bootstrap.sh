#!/usr/bin/env bash
set -e

### ================================
### Arch Linux Pentest Bootstrap
### Compatible: Arch Linux 2026
### VM-aware (VirtualBox)
### ================================

USER_NAME=$(whoami)
REPORT="$HOME/pentest_checklist.txt"

echo "[*] Iniciando bootstrap de Arch Pentesting"
sleep 1

# ==========================================================
# 0. DEPENDENCIAS PARA MÁQUINA VIRTUAL (VirtualBox)
# ==========================================================
echo "[*] Detectando entorno de virtualización..."

VIRT_TYPE=$(systemd-detect-virt || true)

if [[ "$VIRT_TYPE" == "oracle" ]]; then
  echo "[*] VirtualBox detectado — instalando dependencias de VM..."

  sudo pacman -Syu --noconfirm

  sudo pacman -S --needed --noconfirm \
    linux-headers \
    dkms \
    virtualbox-guest-utils \
    mesa \
    xf86-video-vmware \
    xorg-xrandr

  echo "[*] Habilitando servicios de VirtualBox..."
  sudo systemctl enable --now vboxservice

  echo "[✔] Soporte de VirtualBox instalado correctamente"
else
  echo "[*] No se detectó VirtualBox (detectado: ${VIRT_TYPE:-desconocido}) — saltando VM setup"
fi

sleep 1

# -------------------------------
# 1. Paquetes base del sistema
# -------------------------------
echo "[*] Instalando dependencias base..."

sudo pacman -Syu --noconfirm
sudo pacman -S --needed --noconfirm \
  base-devel git curl wget \
  net-tools iproute2 dnsutils whois \
  unzip zip tar \
  tmux htop jq \
  python python-pip \
  neovim \
  proxychains-ng socat \
  openssh rsync \
  tcpdump

# -------------------------------
# 2. Docker (opcional, pero útil)
# -------------------------------
echo "[*] Instalando/activando Docker..."
sudo pacman -S --needed --noconfirm docker docker-compose
sudo systemctl enable --now docker
sudo usermod -aG docker "$USER_NAME"

# -------------------------------
# 3. Instalar yay
# -------------------------------
if ! command -v yay &>/dev/null; then
  echo "[*] Instalando yay..."
  cd /opt
  sudo git clone https://aur.archlinux.org/yay.git
  sudo chown -R "$USER_NAME:$USER_NAME" yay
  cd yay
  makepkg -si --noconfirm
fi

# ==========================================================
# 4. MEDIUM — Recon & Enumeración
# ==========================================================
echo "[*] MEDIUM: Recon & Enumeración..."

yay -S --needed --noconfirm \
  nmap masscan rustscan \
  dnsutils whois arp-scan nbtscan \
  whatweb nikto

# ==========================================================
# 5. MEDIUM — Enumeración Web
# ==========================================================
echo "[*] MEDIUM: Enumeración Web..."

yay -S --needed --noconfirm \
  gobuster ffuf wfuzz feroxbuster dirsearch \
  httpx gau waybackurls

# ==========================================================
# 6. MEDIUM — Explotación base
# ==========================================================
echo "[*] MEDIUM: Explotación base..."

yay -S --needed --noconfirm \
  metasploit sqlmap hydra medusa \
  netexec impacket

# ==========================================================
# 7. MEDIUM — Passwords/Cracking
# ==========================================================
echo "[*] MEDIUM: Passwords/Cracking..."

yay -S --needed --noconfirm \
  hashcat john seclists crunch

# ==========================================================
# 8. HARD — AD / Post / Pivoteo
# ==========================================================
echo "[*] HARD: AD / Post / Pivoteo..."

yay -S --needed --noconfirm \
  responder \
  kerbrute-bin \
  python-ldapdomaindump \
  pspy-bin \
  chisel-bin \
  ligolo-ng

# ==========================================================
# 9. HARD — Network/WiFi/Sniffing
# ==========================================================
echo "[*] HARD: Network/WiFi/Sniffing..."

yay -S --needed --noconfirm \
  wireshark-qt bettercap \
  aircrack-ng reaver \
  hcxdumptool hcxtools

# ==========================================================
# 10. INSANE — Debug/Reverse/Forensics
# ==========================================================
echo "[*] INSANE: Debug/Reverse/Forensics..."

yay -S --needed --noconfirm \
  gdb strace ltrace radare2 \
  binwalk steghide foremost \
  hashid patator \
  exploitdb

# ==========================================================
# 11. Checklist final
# ==========================================================
echo "[*] Generando checklist..."

{
echo "=== ARCH PENTEST CHECKLIST ==="
date
echo

echo "[MEDIUM]"
for c in nmap masscan rustscan whatweb nikto ffuf gobuster sqlmap msfconsole hydra john hashcat; do
  command -v "$c" >/dev/null 2>&1 && echo "✔ $c" || echo "✖ $c"
done
echo

echo "[HARD]"
for c in nxc impacket-smbclient responder kerbrute ldapdomaindump chisel ligolo-ng; do
  command -v "$c" >/dev/null 2>&1 && echo "✔ $c" || echo "✖ $c"
done
echo

echo "[INSANE]"
for c in gdb radare2 binwalk steghide foremost patator searchsploit; do
  command -v "$c" >/dev/null 2>&1 && echo "✔ $c" || echo "✖ $c"
done
echo

echo "Notas:"
echo "- netexec suele exponer el binario: nxc"
echo "- si algo falla por AUR, prueba alternativa -bin / -git."
echo "- VirtualBox detectado automáticamente si aplica."
echo "=== FIN ==="
} | tee "$REPORT"

echo
echo "[✔] Bootstrap finalizado"
echo "[!] Cierra sesión o reinicia para aplicar docker y módulos VM"
echo "[*] Checklist: $REPORT"
