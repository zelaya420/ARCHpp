#!/usr/bin/env bash
set -euo pipefail

### =========================================
### Arch Linux Pentest Bootstrap (2026)
### - VBox-aware
### - Después de yay: TODO se instala con yay
### - Sin paquetes -bin (para evitar conflictos)
### =========================================

USER_NAME="${SUDO_USER:-$(whoami)}"
HOME_DIR="$(eval echo "~$USER_NAME")"
REPORT="$HOME_DIR/pentest_checklist.txt"
LOG="$HOME_DIR/pentest_bootstrap.log"

exec > >(tee -a "$LOG") 2>&1

msg()  { echo -e "\n[*] $*"; }
ok()   { echo -e "[✔] $*"; }
warn() { echo -e "[!] $*"; }

need_sudo() { sudo -v; }

have() { command -v "$1" >/dev/null 2>&1; }

# ---------- yay helpers ----------
yay_run() {
  # Ejecuta yay como usuario normal (correcto para AUR/build)
  sudo -u "$USER_NAME" yay "$@"
}

yay_install() {
  # Instala paquetes (repo o AUR) con yay
  # shellcheck disable=SC2068
  yay_run -S --needed --noconfirm --removemake ${@}
}

# ---------- VM VBox setup ----------
setup_virtualbox_guest() {
  msg "Detectando virtualización…"
  local virt
  virt="$(systemd-detect-virt 2>/dev/null || true)"

  if [[ "$virt" != "oracle" ]]; then
    msg "No es VirtualBox (detectado: ${virt:-desconocido}). Saltando VM setup."
    return 0
  fi

  msg "VirtualBox detectado — preparando guest tools…"

  # Detecta paquete del kernel para elegir headers correctos
  local krel kp headers_pkg
  krel="$(uname -r)"
  kp="$(pacman -Qoq "/usr/lib/modules/${krel}/vmlinuz" 2>/dev/null || true)"
  [[ -z "$kp" ]] && kp="linux"
  headers_pkg="${kp}-headers"

  # Esto es ANTES de yay, así que pacman aquí está permitido
  sudo pacman -Syu --noconfirm
  sudo pacman -S --needed --noconfirm dkms virtualbox-guest-utils "$headers_pkg"

  sudo systemctl enable --now vboxservice >/dev/null 2>&1 || true
  ok "VirtualBox guest listo (kernel: $kp, headers: $headers_pkg)."
}

# ---------- install yay ----------
install_yay() {
  if have yay; then
    ok "yay ya está instalado."
    return 0
  fi

  msg "Instalando dependencias mínimas para compilar yay…"
  sudo pacman -Syu --noconfirm
  sudo pacman -S --needed --noconfirm base-devel git

  msg "Instalando yay…"
  sudo rm -rf /opt/yay >/dev/null 2>&1 || true
  sudo git clone https://aur.archlinux.org/yay.git /opt/yay
  sudo chown -R "$USER_NAME:$USER_NAME" /opt/yay
  ( cd /opt/yay && sudo -u "$USER_NAME" makepkg -si --noconfirm )

  ok "yay instalado."
}

# ---------- base system after yay ----------
install_base_after_yay() {
  msg "Base del sistema (todo con yay desde aquí)…"

  yay_run -Syu --noconfirm

  yay_install \
    base-devel git curl wget \
    ca-certificates \
    net-tools iproute2 iputils \
    bind whois \
    unzip zip p7zip tar \
    tmux htop jq less \
    neovim \
    openssh rsync \
    socat proxychains-ng \
    tcpdump \
    python python-pip python-pipx \
    bash-completion man-db man-pages \
    fzf ripgrep

  # PATH pipx (mejor esfuerzo, sin romper)
  sudo -u "$USER_NAME" pipx ensurepath >/dev/null 2>&1 || true
  ok "Base instalada."
}

install_docker() {
  msg "Docker (opcional pero útil)…"
  yay_install docker docker-compose
  sudo systemctl enable --now docker >/dev/null 2>&1 || true
  sudo usermod -aG docker "$USER_NAME" || true
  ok "Docker instalado (re-login para grupo docker)."
}

# ---------- Pentest toolsets ----------
install_recon_enum() {
  msg "Recon & Enumeración…"
  yay_install \
    nmap masscan rustscan \
    whatweb nikto \
    arp-scan nbtscan \
    traceroute inetutils \
    netcat gnu-netcat \
    tcpdump wireshark-qt tshark \
    snmp \
    openvpn wireguard-tools
  ok "Recon/Enum listo."
}

install_web_enum() {
  msg "Web enum & crawling…"
  yay_install \
    gobuster ffuf wfuzz feroxbuster \
    dirsearch \
    sqlmap \
    gau waybackurls \
    amass \
    theharvester \
    recon-ng
  ok "Web enum listo."
}

install_projectdiscovery() {
  msg "ProjectDiscovery (sin -bin, vía AUR/build)…"
  # Nota: nombres AUR suelen ser exactamente estos (compilan con go)
  yay_install \
    httpx \
    nuclei \
    subfinder \
    naabu \
    dnsx \
    katana
  ok "ProjectDiscovery listo."
}

install_exploitation() {
  msg "Explotación / foothold…"
  yay_install \
    metasploit \
    hydra medusa \
    john hashcat \
    patator \
    exploitdb
  ok "Explotación base lista."
}

install_ad_smb_ldap() {
  msg "AD / SMB / LDAP / Windows enum…"

  # Tooling de red/AD/LDAP desde repos/AUR sin -bin
  yay_install \
    samba smbclient \
    rpcbind \
    openldap \
    krb5 \
    impacket \
    responder \
    netexec \
    enum4linux-ng \
    crackmapexec

  ok "AD/SMB/LDAP listo."
}

install_priv_esc_pivot() {
  msg "Post / PrivEsc / Pivot…"

  # Evito -bin. Si alguno no existe sin -bin en AUR, lo mejor es omitirlo aquí
  # y agregar alternativa por fuente (pero tú pediste que sea sin -bin).
  yay_install \
    chisel \
    ligolo-ng

  ok "Pivot listo."
}

install_wordlists() {
  msg "Wordlists…"
  yay_install seclists
  ok "Wordlists listas (Seclists)."
}

install_web_proxies() {
  msg "Proxies / intercept…"
  # zapproxy existe como paquete (a veces “zaproxy”)
  yay_install \
    mitmproxy \
    zaproxy \
    burpsuite
  ok "Herramientas de proxy listas."
}

install_reverse_forensics() {
  msg "Reverse / Forensics…"
  yay_install \
    gdb strace ltrace \
    radare2 \
    binwalk foremost steghide \
    file binutils \
    ghidra
  ok "Reverse/Forensics listo."
}

install_misc_quality() {
  msg "Utilidades extra (prácticas)…"
  yay_install \
    git-delta \
    gitleaks \
    trufflehog \
    jq \
    openssl
  ok "Extras listos."
}

# ---------- Checklist ----------
generate_checklist() {
  msg "Generando checklist…"

  {
    echo "=== ARCH PENTEST CHECKLIST ==="
    date
    echo
    echo "LOG: $LOG"
    echo

    echo "[BASE]"
    for c in tmux nvim jq curl wget git dig nslookup tcpdump; do
      have "$c" && echo "✔ $c" || echo "✖ $c"
    done
    echo

    echo "[RECON]"
    for c in nmap masscan rustscan whatweb nikto ffuf gobuster wfuzz feroxbuster; do
      have "$c" && echo "✔ $c" || echo "✖ $c"
    done
    echo

    echo "[WEB/CRAWL]"
    for c in sqlmap gau waybackurls amass theHarvester recon-ng; do
      have "$c" && echo "✔ $c" || echo "✖ $c"
    done
    echo

    echo "[PROJECTDISCOVERY]"
    for c in httpx nuclei subfinder naabu dnsx katana; do
      have "$c" && echo "✔ $c" || echo "✖ $c"
    done
    echo

    echo "[EXPLOIT/POST]"
    for c in msfconsole hydra medusa john hashcat patator searchsploit; do
      have "$c" && echo "✔ $c" || echo "✖ $c"
    done
    echo

    echo "[AD/SMB/LDAP]"
    for c in smbclient rpcclient responder nxc ldapsearch; do
      have "$c" && echo "✔ $c" || echo "✖ $c"
    done
    echo

    echo "[PROXIES]"
    for c in mitmproxy zaproxy; do
      have "$c" && echo "✔ $c" || echo "✖ $c"
    done
    echo

    echo "[REVERSE]"
    for c in gdb radare2 binwalk foremost steghide; do
      have "$c" && echo "✔ $c" || echo "✖ $c"
    done
    echo

    echo "Notas:"
    echo "- En Arch: dig/nslookup vienen en el paquete: bind."
    echo "- Tras instalar yay, TODO se instaló con yay (repos + AUR)."
    echo "- Se evitó el sufijo -bin por tu preferencia."
    echo "=== FIN ==="
  } | tee "$REPORT"

  ok "Checklist: $REPORT"
}

main() {
  need_sudo

  msg "Bootstrap iniciando (usuario objetivo: $USER_NAME)"
  setup_virtualbox_guest

  install_yay

  # Desde aquí: TODO con yay (repos + AUR)
  install_base_after_yay
  install_docker

  install_recon_enum
  install_web_enum
  install_projectdiscovery
  install_exploitation
  install_ad_smb_ldap
  install_priv_esc_pivot
  install_wordlists
  install_web_proxies
  install_reverse_forensics
  install_misc_quality

  generate_checklist

  echo
  ok "Bootstrap finalizado"
  warn "Recomendado: cerrar sesión/reiniciar (docker + módulos VBox si aplica)."
  warn "Checklist: $REPORT"
}

main "$@"
